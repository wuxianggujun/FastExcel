cmake_minimum_required(VERSION 3.10)
project(FastExcel VERSION 1.0.0 LANGUAGES CXX C)

# =============================================================================
# é¡¹ç›®é…ç½®é€‰é¡¹
# =============================================================================
option(FASTEXCEL_BUILD_SHARED_LIBS "Build FastExcel as shared library" OFF)
option(FASTEXCEL_USE_SYSTEM_LIBS "Use system libraries when available" OFF)
option(FASTEXCEL_USE_LIBDEFLATE "Enable libdeflate for high-performance compression" OFF)
option(FASTEXCEL_BUILD_EXAMPLES "Build example programs" ON)
option(FASTEXCEL_BUILD_TESTS "Build all tests" ON)
option(FASTEXCEL_BUILD_UNIT_TESTS "Build unit tests" ON)
option(FASTEXCEL_BUILD_INTEGRATION_TESTS "Build integration tests" OFF)
option(FASTEXCEL_INSTALL "Enable installation" OFF)

# =============================================================================
# ç¼–è¯‘æ ‡å‡†è®¾ç½®
# =============================================================================
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)

# =============================================================================
# æ„å»ºç±»å‹é…ç½®
# =============================================================================
if (NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE "Release" CACHE STRING "Build type" FORCE)
endif ()

# è®¾ç½®è¾“å‡ºç›®å½•
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# =============================================================================
# ç¬¬ä¸‰æ–¹åº“é…ç½®
# =============================================================================
add_subdirectory(third_party)

# =============================================================================
# FastExcel åº“æºæ–‡ä»¶
# =============================================================================
set(FASTEXCEL_SOURCES
        src/fastexcel/FastExcel.cpp
        src/fastexcel/archive/ZipArchive.cpp
        src/fastexcel/archive/ZipReader.cpp
        src/fastexcel/archive/ZipWriter.cpp
        src/fastexcel/archive/FileManager.cpp
        src/fastexcel/archive/MinizipParallelWriter.cpp
        src/fastexcel/archive/CompressionEngine.cpp
        src/fastexcel/archive/ZlibEngine.cpp
        src/fastexcel/core/Color.cpp
        src/fastexcel/core/Cell.cpp
        src/fastexcel/core/Exception.cpp
        src/fastexcel/core/FormatDescriptor.cpp
        src/fastexcel/core/Path.cpp
        src/fastexcel/core/Workbook.cpp
        src/fastexcel/core/Worksheet.cpp
        src/fastexcel/core/WorksheetChain.cpp  # ğŸš€ æ–°å¢ï¼šé“¾å¼è°ƒç”¨åŠ©æ‰‹ç±»
        src/fastexcel/core/SharedStringTable.cpp
        src/fastexcel/core/SharedFormula.cpp
        src/fastexcel/core/FormatRepository.cpp
        src/fastexcel/core/MemoryPool.cpp
        src/fastexcel/core/ErrorCode.cpp
        src/fastexcel/core/ThreadPool.cpp
        src/fastexcel/core/StyleTransferContext.cpp
        # Unified XML generation pipeline and writers
        src/fastexcel/core/ExcelStructureGenerator.cpp
        src/fastexcel/core/BatchFileWriter.cpp
        src/fastexcel/core/StreamingFileWriter.cpp
        src/fastexcel/core/StyleBuilder.cpp
        # Enhanced Format API (v2.1.0)
        src/fastexcel/core/RangeFormatter.cpp
        src/fastexcel/core/QuickFormat.cpp
        src/fastexcel/core/FormatUtils.cpp
        src/fastexcel/reader/XLSXReader.cpp
        src/fastexcel/reader/StylesParser.cpp
        src/fastexcel/reader/SharedStringsParser.cpp
        src/fastexcel/reader/WorksheetParser.cpp
        src/fastexcel/reader/RelationshipsParser.cpp  # æ–°å¢ï¼šä¸“é—¨çš„å…³ç³»è§£æå™¨ï¼Œéµå¾ªå•ä¸€èŒè´£åŸåˆ™
        src/fastexcel/reader/ContentTypesParser.cpp   # æ–°å¢ï¼šä¸“é—¨çš„å†…å®¹ç±»å‹è§£æå™¨ï¼Œæé«˜å¤ç”¨æ€§
        src/fastexcel/utils/Logger.cpp
        src/fastexcel/xml/ContentTypes.cpp
        src/fastexcel/xml/Relationships.cpp
        src/fastexcel/xml/SharedStrings.cpp
        src/fastexcel/xml/XMLStreamWriter.cpp
        src/fastexcel/xml/XMLStreamReader.cpp
        src/fastexcel/xml/StyleSerializer.cpp
        src/fastexcel/xml/UnifiedXMLGenerator.cpp
        src/fastexcel/xml/PartGenerators.cpp
        src/fastexcel/xml/WorksheetXMLGenerator.cpp
        src/fastexcel/xml/DocPropsXMLGenerator.cpp
         src/fastexcel/theme/Theme.cpp
         src/fastexcel/theme/ThemeParser.cpp
        # OPC Repack Architecture (New)
        src/fastexcel/opc/PackageEditor.cpp
        src/fastexcel/opc/PackageEditorManager.cpp
        src/fastexcel/opc/ZipRepackWriter.cpp
        src/fastexcel/opc/PartGraph.cpp
        # Tracking services
        src/fastexcel/tracking/StandardChangeTracker.cpp
        
)

# å¦‚æœå¯ç”¨äº† libdeflateï¼Œæ·»åŠ ç›¸å…³æºæ–‡ä»¶
if(FASTEXCEL_USE_LIBDEFLATE)
    list(APPEND FASTEXCEL_SOURCES
        src/fastexcel/archive/LibDeflateEngine.cpp
    )
endif()

# =============================================================================
# åˆ›å»º FastExcel åº“
# =============================================================================
if (FASTEXCEL_BUILD_SHARED_LIBS)
    add_library(fastexcel SHARED ${FASTEXCEL_SOURCES})
    target_compile_definitions(fastexcel PRIVATE FASTEXCEL_EXPORTS)
    target_compile_definitions(fastexcel INTERFACE FASTEXCEL_SHARED)
    message(STATUS "FastExcel: Building shared library")
else ()
    add_library(fastexcel STATIC ${FASTEXCEL_SOURCES})
    message(STATUS "FastExcel: Building static library")
endif ()

# è®¾ç½®åº“ç‰ˆæœ¬
set_target_properties(fastexcel PROPERTIES
        VERSION ${PROJECT_VERSION}
        SOVERSION ${PROJECT_VERSION_MAJOR}
        OUTPUT_NAME "fastexcel"
)

# =============================================================================
# åŒ…å«ç›®å½•é…ç½®
# =============================================================================
target_include_directories(fastexcel PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/src>
        $<INSTALL_INTERFACE:include>
)

target_include_directories(fastexcel PRIVATE
        ${FASTEXCEL_THIRD_PARTY_INCLUDE_DIRS}
)

# UTF8-CPPéœ€è¦ä½œä¸ºINTERFACEåŒ…å«ï¼Œå› ä¸ºPath.hppæ˜¯å…¬å…±å¤´æ–‡ä»¶å¹¶åŒ…å«utf8.h
target_include_directories(fastexcel INTERFACE
        ${CMAKE_CURRENT_SOURCE_DIR}/third_party/utfcpp/source
)

# ç¡®ä¿ç¬¬ä¸‰æ–¹åº“çš„å¤´æ–‡ä»¶èƒ½è¢«æ‰¾åˆ°
target_include_directories(fastexcel PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/third_party/libexpat/expat/lib
        ${CMAKE_CURRENT_SOURCE_DIR}/third_party/fmt/include
        ${CMAKE_CURRENT_SOURCE_DIR}/third_party/minizip-ng
)

# =============================================================================
# é“¾æ¥åº“é…ç½®
# =============================================================================
target_link_libraries(fastexcel PRIVATE
        fmt::fmt
        ${FASTEXCEL_EXPAT_TARGET}
)

# åªæœ‰å½“ minizip ç›®æ ‡å­˜åœ¨æ—¶æ‰é“¾æ¥
if (FASTEXCEL_MINIZIP_TARGET AND NOT FASTEXCEL_MINIZIP_TARGET STREQUAL "")
    target_link_libraries(fastexcel PRIVATE ${FASTEXCEL_MINIZIP_TARGET})
    message(STATUS "FastExcel: Linking with minizip target: ${FASTEXCEL_MINIZIP_TARGET}")
else ()
    message(WARNING "FastExcel: minizip target not available, ZipArchive functionality will be limited")
endif ()

# é“¾æ¥ libdeflateï¼ˆå¦‚æœå¯ç”¨ï¼‰
if (FASTEXCEL_LIBDEFLATE_TARGET AND NOT FASTEXCEL_LIBDEFLATE_TARGET STREQUAL "")
    target_link_libraries(fastexcel PRIVATE ${FASTEXCEL_LIBDEFLATE_TARGET})
    message(STATUS "FastExcel: Linking with libdeflate target: ${FASTEXCEL_LIBDEFLATE_TARGET}")
endif ()

# =============================================================================
# å®å®šä¹‰é…ç½®
# =============================================================================
# å¦‚æœå¯ç”¨äº† libdeflateï¼Œå®šä¹‰ç›¸åº”çš„å®
if(FASTEXCEL_USE_LIBDEFLATE AND FASTEXCEL_HAS_LIBDEFLATE)
    target_compile_definitions(fastexcel PRIVATE FASTEXCEL_HAS_LIBDEFLATE=1)
    message(STATUS "FastExcel: FASTEXCEL_HAS_LIBDEFLATE macro defined")
endif()


# =============================================================================
# ç¼–è¯‘å™¨é…ç½®
# =============================================================================
if (MSVC)
    target_compile_options(fastexcel PRIVATE /W4)
    # ç¦ç”¨ä¸€äº›ä¸å¿…è¦çš„è­¦å‘Š
    target_compile_options(fastexcel PRIVATE /wd4251 /wd4275)
    # è®¾ç½®æºæ–‡ä»¶å’Œæ‰§è¡Œå­—ç¬¦é›†ä¸ºUTF-8ï¼Œè§£å†³C4819ç¼–ç è­¦å‘Š
    target_compile_options(fastexcel PRIVATE /utf-8)
else ()
    target_compile_options(fastexcel PRIVATE -Wall -Wextra -Wpedantic)
endif ()

# =============================================================================
# ä¸»ç¨‹åº
# =============================================================================
if (EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/main.cpp")
    add_executable(${PROJECT_NAME} src/main.cpp)
    target_link_libraries(${PROJECT_NAME} PRIVATE fastexcel)

    # ç¡®ä¿ä¸»ç¨‹åºä¹Ÿèƒ½è®¿é—®ç¬¬ä¸‰æ–¹åº“çš„å¤´æ–‡ä»¶
    target_include_directories(${PROJECT_NAME} PRIVATE
            ${CMAKE_CURRENT_SOURCE_DIR}/third_party/fmt/include
            ${FASTEXCEL_THIRD_PARTY_INCLUDE_DIRS}
    )

    # ä¸ºä¸»ç¨‹åºæ·»åŠ UTF-8ç¼–è¯‘é€‰é¡¹
    if (MSVC)
        target_compile_options(${PROJECT_NAME} PRIVATE /utf-8)
    endif ()

    set_target_properties(${PROJECT_NAME} PROPERTIES
            OUTPUT_NAME "fastexcel_demo"
    )
endif ()

# =============================================================================
# ç¤ºä¾‹ç¨‹åº
# =============================================================================
if (FASTEXCEL_BUILD_EXAMPLES)
    add_subdirectory(examples)
endif ()

# =============================================================================
# æµ‹è¯•
# =============================================================================
if (FASTEXCEL_BUILD_TESTS)
    enable_testing()
    add_subdirectory(test)
endif ()

# =============================================================================
# å®‰è£…é…ç½®ï¼ˆå¯é€‰ï¼‰
# =============================================================================
if (FASTEXCEL_INSTALL)
    include(GNUInstallDirs)

    # å®‰è£…åº“æ–‡ä»¶
    install(TARGETS fastexcel
            LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
            ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
            RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    )

    # å®‰è£…å¤´æ–‡ä»¶
    install(DIRECTORY src/fastexcel
            DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
            FILES_MATCHING PATTERN "*.hpp"
    )
endif ()

# =============================================================================
# æ‰“å°é…ç½®ä¿¡æ¯
# =============================================================================
message(STATUS "")
message(STATUS "FastExcel Configuration Summary:")
message(STATUS "  Version: ${PROJECT_VERSION}")
message(STATUS "  Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "  Shared libraries: ${FASTEXCEL_BUILD_SHARED_LIBS}")
message(STATUS "  Use system libs: ${FASTEXCEL_USE_SYSTEM_LIBS}")
message(STATUS "  Use libdeflate: ${FASTEXCEL_USE_LIBDEFLATE}")
message(STATUS "  Build examples: ${FASTEXCEL_BUILD_EXAMPLES}")
message(STATUS "  Build tests: ${FASTEXCEL_BUILD_TESTS}")
message(STATUS "  Install prefix: ${CMAKE_INSTALL_PREFIX}")
message(STATUS "")
